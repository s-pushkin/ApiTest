name: ApiTest
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Setup Java JDK
        uses: actions/setup-java@v4.6.0
        with:
          java-version: 17
          distribution: zulu

      - name: Set up Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

  test_all:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Set execute permissions on gradlew
        run: chmod +x ./gradlew

      - name: Run All Tests
        run: ./gradlew testAll

      - name: Debug Allure Results
        run: |
          echo "Checking allure-results directory:"
          ls -R build/allure-results || echo "No results found"

  allure_report:
    runs-on: ubuntu-latest
    needs: test_all
    steps:
      - name: Run tests and generate Allure report
        run: ./gradlew test allureReport

      # 6. Установить Allure Commandline для сервера отчётов
      - name: Install Allure Commandline
        run: |
          sudo apt-get update
          sudo apt-get install -y allure

      # 7. Генерация отчёта Allure
      - name: Generate Allure Report
        run: |
          allure serve build/allure-results
